import os
import sys
import subprocess
import time
import datetime
import cPickle
import json
import base64
import numpy as np

from config import config_list, configs

config_list = {"xp1":[
                    "M-NN-RMB",
                    "M-NN-LP-AMB",
                    "M-LWLR-RMB",
                    "M-LWLR-LP-AMB",
                    "M-NN-RMB-ENVNOISE",
                    "M-NN-LP-AMB-ENVNOISE",
                    "M-LWLR-RMB-ENVNOISE",
                    "M-LWLR-LP-AMB-ENVNOISE",
                      ]}



path = '/home/sforestier/software/IROS2016/src/'

log_dir = '/scratch/sforestier001/logs/2016-02-26_11-56-40-TOOL2-iros_100T_14C_100K-'


def write_pbs(config_name, trial, log_dir):
    pbs =   """
#!/bin/sh

#PBS -l walltime=00:10:00
#PBS -l nodes=1:ppn=1
#PBS -N {}-{}
#PBS -o {}logs/log-{}-{}-comp.output
#PBS -e {}logs/log-{}-{}-comp.error

cd {}
time python analysis_comp.py {} {}

""".format(config_name, trial, log_dir, config_name, trial, log_dir, config_name, trial, path, config_name, trial)
    filename = '{}-{}.pbs'.format(config_name, trial)
    with open(log_dir + "pbs_comp/" + filename, 'wb') as f:
        f.write(pbs)


xp_list = [
           "xp1", 
#             "xp2", 
#             "xp3",
#             "xp4",
#             "xp5"
]




n_iter = 1
iter_list = range(1,n_iter + 1) 


for xp_name in xp_list:
    os.mkdir(log_dir + xp_name + "/" + "comp")
    
    
        
for xp_name in xp_list:
    for trial in iter_list:
        for config_name in config_list[xp_name]:
            print xp_name, config_name, trial
            write_pbs(config_name, trial, log_dir + xp_name + "/")   
            filename = '{}-{}.pbs'.format(config_name, trial)
            
            print "Run qsub", config_name, trial
            print "qsub " + log_dir + xp_name + "/pbs_comp/" + filename
            process = subprocess.Popen("qsub " + log_dir + xp_name + "/pbs_comp/" + filename, shell=True, stdout=subprocess.PIPE)
            time.sleep(0.5)
